<!DOCTYPE html>
<html lang="eng">

<script>
    //Functions

    function join_lobby_req()
    {
        lobbyid = document.getElementById("lobbyid").value;


        var request = new XMLHttpRequest();
        request.open("POST","php/lobby_request.php",true);
        request.setRequestHeader("Content-Type","application/x-www-form-urlencoded");

        request.onreadystatechange= function ()
        {
            
            if ((this.readyState == 4)&&(this.status == 200))
            {
                //console.log(this.responseText);
                HandleLoginResponse(this.responseText);
            }		
        }
        localStorage.setItem("lobby_id", lobbyid);
        localStorage.setItem("lobby_host", false);
        
        window.location.replace("lobby_game.html");
        request.send("type=join&lobbyid="+lobbyid);
    }

    function create_lobby_req(){
        var request = new XMLHttpRequest();
        request.open("POST","php/lobby_request.php",true);
        request.setRequestHeader("Content-Type","application/x-www-form-urlencoded");

        request.onreadystatechange= function ()
        {
            
            if ((this.readyState == 4)&&(this.status == 200))
            {
                //console.log(this.responseText);
                if(this.responseText.length == 4){
                    localStorage.setItem("lobby_id", this.responseText);
                    localStorage.setItem("lobby_host", "true");
                    console.log(localStorage.getItem("lobby_id"));
                    window.location.replace("lobby_game.html");
                }
            }		
        }
        request.send("type=create");
    }

    function list_lobbies(){
        var request = new XMLHttpRequest();
        request.open("POST","php/lobby_request.php",true);
        request.setRequestHeader("Content-Type","application/x-www-form-urlencoded");

        request.onreadystatechange= function ()
        {
            
            if ((this.readyState == 4)&&(this.status == 200))
            {
                //console.log(this.responseText);
                sessionStorage.setItem("lobbies", this.responseText);
            }		
        }
        request.send("type=list");
    }

    //Populate a list marked by an id
    function list_html(id, data_array)
    {
        var list = document.getElementById(id);
        console.log(typeof(data_array));
        for (var i = 0; i < data_array.length; i++)
        {
            var li = document.createElement("li");
            var text = data_array[i][0];
            if(document.createTextNode(data_array[i][1] == '0')){
                text = text + " | Pre-Game";
            }else{
                text = text + " | In Game";
            }
            li.appendChild(document.createTextNode( text ));
            list.appendChild(li);
        }
    }

</script>

<head>

    <title>Home | SteamTag</title>

</head>

<body>

    <header>

        <nav>

            <a href="lobby_home.html">Home</a> | 
            <a href="user_profile.html">Profile</a> | 
            <a href="user_settings.html">Settings</a> |
            <a href="index.html">Login</a>

        </nav>

    </header>

    <main>

        <!--Lobby Request-->
        <form action="javascript:join_lobby_req()">
            <label for="lobbyid">Lobby ID:</label><br>
            <input type="text" id="lobbyid" name="lobbyid"><br>
            <input type="submit" value="Join Lobby">
        </form>

        <h3>Or</h3>

        <form action="javascript:create_lobby_req()">
            <input type="submit" value="Create Lobby">
        </form>

    </main>

    <aside>

        <h2>Active Lobbies</h2>
        <ul id="lobby_list"></ul>
        
    </aside>

    <footer>

    </footer>

</body>

<script>
    //Function Calls
    list_lobbies();
    let active_lobbies = JSON.parse(sessionStorage.getItem("lobbies"));
    console.log(active_lobbies);
    list_html("lobby_list", active_lobbies);
</script>

</html>